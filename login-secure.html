<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign In | Alumil Inventory System</title>
  
  <!-- Security Headers -->
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://grsikgldzkqntlotawyi.supabase.co; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;">
  
  <!-- Comprehensive Favicon Setup -->
  <link rel="icon" href="/favicon.ico?v=6" type="image/x-icon">
  <link rel="shortcut icon" href="/favicon.ico?v=6" type="image/x-icon">
  <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg?v=6">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png?v=6">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png?v=6">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png?v=6">
  <link rel="manifest" href="/favicon/site.webmanifest?v=6">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg?v=6" color="#ffc107">
  <meta name="theme-color" content="#ffc107">
  <meta name="msapplication-config" content="/favicon/browserconfig.xml?v=6">
  <meta name="theme-color" content="#ffffff">
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Load Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Load our configuration and security utilities -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/security.js"></script>
  <script src="assets/js/supabase-service.js"></script>
  
  <!-- Supabase Configuration -->
  <script>
    // Supabase project configuration
    window.SUPABASE_URL = 'https://grsikgldzkqntlotawyi.supabase.co';
    window.SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyc2lrZ2xkemtxbnRsb3Rhd3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTQ0NTQsImV4cCI6MjA3NTE3MDQ1NH0.RtGvQ7vDNFNiabghTWVEzFroA4Z_fc8ZTr9p07fk_eQ';
    
    // Initialize Supabase client
    window._sbClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
    console.log('âœ… Supabase client initialized');
  </script>
  
  <!-- Theme initialization -->
  <script>
    (function(){
      try{
        var t = localStorage.getItem('alumil:theme') || localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', t);
      }catch(e){ document.documentElement.setAttribute('data-theme', 'light'); }
    })();
  </script>
  
  <style>
    :root {
      --panel-bg: rgba(60, 60, 60, 0.55);
      --panel-border: rgba(255,255,255,.15);
      --text: #eaeaea;
      --muted: #d6d6d6;
      --blue: #2a7de1;      /* primary button */
      --blue-press: #1f66bd;
      --yellow: #d9b531;     /* separators */
      --input-bg: rgba(255,255,255,.08);
      --input-border: rgba(255,255,255,.2);
      --shadow: 0 18px 45px rgba(0,0,0,.25);
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--text);
      display: grid;
      place-items: center;
      background: #111;
      overflow: hidden;
    }

    /* Background with Alumil branding */
    .bg {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      z-index: -1;
    }

    /* Optional: Add subtle pattern overlay */
    .bg::after {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 193, 7, 0.1) 0%, transparent 50%);
    }

    .panel {
      width: min(420px, calc(100vw - 32px));
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding: 28px 26px;
      position: relative;
      z-index: 1;
    }

    .brand {
      display:flex; align-items:center; justify-content:center;
      margin-bottom: 20px;
      user-select:none;
    }
    .brand img { 
      height: 40px; 
      opacity: .95;
      filter: brightness(0) invert(1); /* Make logo white for dark theme */
    }
    html[data-theme="light"] .brand img {
      filter: none; /* Show normal logo for light theme */
    }

    .flags {
      display:flex; gap: 10px; justify-content:center; margin: 8px 0 18px;
      opacity:.95; flex-wrap: wrap;
    }
    .flag {
      width: 20px; height: 14px; border-radius: 2px;
      background: #bbb; box-shadow: 0 0 0 1px rgba(255,255,255,.25) inset;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .flag:hover { transform: scale(1.1); }

    /* Country flag colors */
    .flag-gr { background: linear-gradient(to bottom, #0d5eaf 0%, #0d5eaf 50%, #ffffff 50%, #ffffff 100%); }
    .flag-ro { background: linear-gradient(to right, #002b7f 0%, #002b7f 33%, #fcd116 33%, #fcd116 66%, #ce1126 66%); }
    .flag-bg { background: linear-gradient(to bottom, #ffffff 0%, #ffffff 33%, #00966e 33%, #00966e 66%, #d62612 66%); }
    .flag-pl { background: linear-gradient(to bottom, #ffffff 0%, #ffffff 50%, #dc143c 50%); }
    .flag-rs { background: linear-gradient(to bottom, #c6363c 0%, #c6363c 33%, #0c4076 33%, #0c4076 66%, #ffffff 66%); }
    .flag-al { background: #e41e20; }
    .flag-mk { background: linear-gradient(to bottom, #d20000 0%, #d20000 50%, #ffce00 50%); }

    /* Footer Styles */
    .alumil-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      padding: 12px 0;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      z-index: 1000;
    }
    
    .alumil-footer p {
      margin: 0;
      font-weight: 500;
    }

    h1 {
      text-align:center; margin: 6px 0 8px; font-size: 24px; font-weight: 600; letter-spacing:.2px;
    }

    .subtitle {
      text-align: center; 
      color: var(--muted); 
      font-size: 14px; 
      margin-bottom: 24px;
      font-weight: 400;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    input[type="email"], input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
      transition: all 0.2s ease;
    }

    input[type="email"]:focus, input[type="password"]:focus {
      outline: none;
      border-color: #ffc107;
      box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2);
    }

    input[type="email"]::placeholder, input[type="password"]::placeholder {
      color: var(--muted);
    }

    .btn {
      display:flex; align-items:center; justify-content:center;
      gap:10px; width:100%;
      padding: 14px 16px; border-radius: var(--radius);
      text-decoration:none; color:#000; font-weight: 600;
      background: #ffc107;
      box-shadow: 0 6px 14px rgba(255, 193, 7, .35);
      transition: transform .04s ease, background .15s ease, box-shadow .15s ease;
      border: 0;
      cursor: pointer;
      font-size: 15px;
      margin-top: 8px;
    }
    .btn:active { transform: translateY(1px); background: #e0a800; box-shadow: 0 4px 10px rgba(255, 193, 7, .28); }
    .btn:hover { box-shadow: 0 8px 18px rgba(255, 193, 7, .45); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .login-icon {
      width: 18px; height: 18px; display:inline-block;
      background: currentColor;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpath d='M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4'/%3E%3Cpolyline points='10,17 15,12 10,7'/%3E%3Cline x1='15' y1='12' x2='3' y2='12'/%3E%3C/svg%3E") center/contain no-repeat;
    }

    .divider {
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px;
      color: var(--muted); font-size: 12px; margin: 20px 0;
    }
    .divider::before, .divider::after {
      content:""; height: 2px; background: linear-gradient(90deg, transparent, var(--yellow), transparent);
      border-radius: 2px;
    }

    .actions { display:flex; gap:10px; margin-top: 14px; justify-content: center; }
    .ghost {
      flex: none;
      display:flex; align-items:center; justify-content:center;
      padding: 12px 24px; border-radius: var(--radius);
      text-decoration:none; color:#eaeaea; font-weight: 500;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      transition: all 0.2s ease;
      font-size: 14px;
      cursor: pointer;
    }
    .ghost:hover {
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.3);
    }

    .muted { color: var(--muted); text-align:center; font-size: 12px; margin-top:14px; }

    .error-message {
      background: rgba(255, 80, 80, .12);
      color: #ffd1d1;
      border: 1px solid rgba(255, 120, 120, .25);
      padding: 10px 12px; border-radius: 10px; font-size: 13px; margin-bottom: 14px;
      display: none;
    }

    @media (max-height: 620px) {
      .panel { transform: scale(.96); }
    }

    @media (max-width: 480px) {
      .panel { padding: 24px 20px; }
      h1 { font-size: 22px; }
      .actions { flex-direction: column; }
      .ghost { text-align: center; }
    }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <main class="panel" role="main" aria-labelledby="title">
    <!-- Adding the brand logo section -->
    <div class="brand">
      <img src="assets/images/alumil-logo.svg" alt="Alumil Logo" loading="eager" style="height:40px;">
    </div>
    
    <div class="flags" aria-label="Available regions">
      <div class="flag flag-gr" title="Greece"></div>
      <div class="flag flag-ro" title="Romania"></div>
      <div class="flag flag-bg" title="Bulgaria"></div>
      <div class="flag flag-pl" title="Poland"></div>
      <div class="flag flag-rs" title="Serbia"></div>
      <div class="flag flag-al" title="Albania"></div>
      <div class="flag flag-mk" title="North Macedonia"></div>
    </div>

    <h1 id="title">Sign In</h1>
    <p class="subtitle">Access your Inventory Management System</p>

    <div class="error-message" id="error-message"></div>

    <form id="login-form">
      <!-- Hidden CSRF token for form security -->
      <input type="hidden" id="csrf-token" name="csrf-token">
      
      <div class="form-group">
        <label for="email">Email Address</label>
        <input id="email" type="email" placeholder="Enter your email" required>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Enter your password" required>
      </div>

      <div class="form-group" id="confirm-password-group" style="display: none;">
        <label for="confirm-password">Confirm Password</label>
        <input id="confirm-password" type="password" placeholder="Confirm your password">
      </div>

      <button type="submit" class="btn" id="login-btn">
        <span class="login-icon" aria-hidden="true"></span>
        <span id="btn-text">Sign In</span>
      </button>
    </form>

    <div class="divider">OR</div>

    <div class="actions">
      <button type="button" class="ghost" id="toggle-mode">Don't have an account? Register</button>
    </div>

    <p class="muted">Secure access to Alumil inventory system</p>
  </main>

  <script>
    // Security utilities for input validation and sanitization
    const SecurityHelpers = {
      // Enhanced email validation
      isValidEmail: function(email) {
        if (!email) return false;
        // RFC 5322 compliant email regex
        const emailPattern = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        return emailPattern.test(String(email).toLowerCase());
      },

      // Enhanced password validation
      isStrongPassword: function(password) {
        if (!password) return false;
        // At least 8 characters with a mix of requirements
        return password.length >= 8 && 
               /[A-Z]/.test(password) && // has uppercase
               /[a-z]/.test(password) && // has lowercase
               /[0-9]/.test(password);   // has number
      },

      // Input sanitization
      sanitizeInput: function(input) {
        // Basic sanitization - convert to string and trim
        return (input === null || input === undefined) ? '' : String(input).trim();
      }
    };

    // Rate limiting utilities
    const RateLimiter = {
      KEY_PREFIX: 'alumil_auth_',
      MAX_ATTEMPTS: 5,
      LOCKOUT_TIME: 15 * 60 * 1000, // 15 minutes

      // Get attempt count for an email
      getAttempts: function(email) {
        const key = this.KEY_PREFIX + email;
        try {
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          // Clear expired lockouts
          if (data.lockoutUntil && Date.now() > data.lockoutUntil) {
            this.resetAttempts(email);
            return 0;
          }
          return data.attempts || 0;
        } catch (e) {
          return 0;
        }
      },

      // Check if account is locked
      isLocked: function(email) {
        const key = this.KEY_PREFIX + email;
        try {
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          return data.lockoutUntil && Date.now() < data.lockoutUntil;
        } catch (e) {
          return false;
        }
      },

      // Get remaining lockout time in minutes
      getLockoutMinutes: function(email) {
        const key = this.KEY_PREFIX + email;
        try {
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          if (!data.lockoutUntil || Date.now() > data.lockoutUntil) return 0;
          return Math.ceil((data.lockoutUntil - Date.now()) / 60000);
        } catch (e) {
          return 0;
        }
      },

      // Record a failed attempt
      recordFailedAttempt: function(email) {
        const key = this.KEY_PREFIX + email;
        try {
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          const attempts = (data.attempts || 0) + 1;
          
          // Lock account if max attempts reached
          if (attempts >= this.MAX_ATTEMPTS) {
            localStorage.setItem(key, JSON.stringify({
              attempts: attempts,
              lockoutUntil: Date.now() + this.LOCKOUT_TIME
            }));
          } else {
            localStorage.setItem(key, JSON.stringify({
              attempts: attempts,
              lockoutUntil: data.lockoutUntil
            }));
          }
          
          return attempts;
        } catch (e) {
          console.error('Failed to record attempt:', e);
          return 1;
        }
      },

      // Reset attempts after successful login
      resetAttempts: function(email) {
        const key = this.KEY_PREFIX + email;
        try {
          localStorage.removeItem(key);
        } catch (e) {
          console.error('Failed to reset attempts:', e);
        }
      }
    };

    // Check if we already have a session
    (async function() {
      try {
        // Use either the supabase service or direct client
        const supabaseClient = window._sbClient || window.SupabaseService?.init();
        if (!supabaseClient) {
          console.error('Failed to initialize Supabase client');
          return;
        }
        
        // Check for existing session
        const { data } = await supabaseClient.auth.getSession();
        if (data?.session) {
          // Determine user's role
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('is_admin')
            .eq('id', data.session.user.id)
            .single();
            
          // Redirect based on user role
          if (profile?.is_admin) {
            location.href = 'admin.html';
          } else {
            location.href = 'home.html';
          }
        }
      } catch (e) {
        console.warn('Session check failed:', e);
      }
    })();
  
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const errorMessage = document.getElementById('error-message');
    const toggleMode = document.getElementById('toggle-mode');
    const title = document.getElementById('title');
    const btnText = document.getElementById('btn-text');
    const confirmPasswordGroup = document.getElementById('confirm-password-group');
    const csrfToken = document.getElementById('csrf-token');
    
    let isRegisterMode = false;
    
    // Set CSRF token for form security
    if (window.SecurityUtils) {
      csrfToken.value = window.SecurityUtils.generateCSRFToken();
    }
    
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }
    
    function hideError() {
      errorMessage.style.display = 'none';
    }
    
    function toggleAuthMode() {
      isRegisterMode = !isRegisterMode;
      
      if (isRegisterMode) {
        title.textContent = 'Register';
        btnText.textContent = 'Register';
        toggleMode.textContent = 'Already have an account? Sign In';
        confirmPasswordGroup.style.display = 'block';
        document.getElementById('confirm-password').required = true;
      } else {
        title.textContent = 'Sign In';
        btnText.textContent = 'Sign In';
        toggleMode.textContent = "Don't have an account? Register";
        confirmPasswordGroup.style.display = 'none';
        document.getElementById('confirm-password').required = false;
      }
      hideError();
    }
    
    toggleMode.addEventListener('click', toggleAuthMode);
    
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();
      
      // Sanitize inputs
      const email = SecurityHelpers.sanitizeInput(document.getElementById('email').value);
      const password = document.getElementById('password').value; // Don't trim passwords
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // Enhanced input validation
      if (!email || !password) {
        showError('Please enter both email and password');
        return;
      }
      
      if (!SecurityHelpers.isValidEmail(email)) {
        showError('Please enter a valid email address');
        return;
      }
      
      if (isRegisterMode) {
        if (password !== confirmPassword) {
          showError('Passwords do not match');
          return;
        }
        
        if (!SecurityHelpers.isStrongPassword(password)) {
          showError('Password must be at least 8 characters and include uppercase, lowercase, and numbers');
          return;
        }
      } else {
        // Check for rate limiting on login attempts
        if (RateLimiter.isLocked(email)) {
          const minutes = RateLimiter.getLockoutMinutes(email);
          showError(`Too many failed login attempts. Please try again in ${minutes} minute${minutes !== 1 ? 's' : ''}.`);
          return;
        }
      }
      
      // Show loading state
      loginBtn.disabled = true;
      loginBtn.innerHTML = isRegisterMode ? '<span>Registering...</span>' : '<span>Signing in...</span>';
      
      try {
        let result;
        
        // Determine which Supabase client to use (direct or via service)
        const supabaseService = window.SupabaseService;
        const supabaseClient = window._sbClient;
        
        if (isRegisterMode) {
          // Register new user
          if (supabaseService && typeof supabaseService.signUp === 'function') {
            result = await supabaseService.signUp(email, password, email.split('@')[0]);
          } else {
            // Direct Supabase client fallback
            const { data, error } = await supabaseClient.auth.signUp({
              email,
              password,
              options: { data: { full_name: email.split('@')[0] } }
            });
            
            result = {
              success: !error,
              data: data || {},
              error: error
            };
          }
          
          if (!result.success) {
            showError(result.error?.message || 'Registration failed');
            return;
          }
          
          if (result.data.user) {
            showError('Registration successful! You can now sign in.');
            toggleAuthMode(); // Switch back to login mode
            return;
          }
        } else {
          // Sign in existing user
          if (supabaseService && typeof supabaseService.signIn === 'function') {
            result = await supabaseService.signIn(email, password);
          } else {
            // Direct Supabase client fallback
            const { data, error } = await supabaseClient.auth.signInWithPassword({
              email,
              password
            });
            
            result = {
              success: !error,
              data: data || {},
              error: error
            };
          }
          
          if (!result.success) {
            // Record failed attempt for rate limiting
            const attempts = RateLimiter.recordFailedAttempt(email);
            const attemptsLeft = RateLimiter.MAX_ATTEMPTS - attempts;
            
            if (attemptsLeft <= 0) {
              showError(`Too many failed login attempts. Your account is locked for 15 minutes.`);
            } else if (attemptsLeft <= 2) {
              showError(`${result.error?.message || 'Invalid login'}. ${attemptsLeft} attempt${attemptsLeft !== 1 ? 's' : ''} remaining before lockout.`);
            } else {
              showError(result.error?.message || 'Invalid email or password');
            }
            return;
          }
          
          // Reset attempt counter on successful login
          RateLimiter.resetAttempts(email);
          
          // Check user role after successful login
          let profile;
          
          try {
            // Try to use direct client first
            const { data: profileData, error: profileError } = await supabaseClient
              .from('profiles')
              .select('is_admin')
              .eq('id', result.data.user.id)
              .single();
              
            if (profileError) throw profileError;
            profile = profileData;
          } catch (profileError) {
            console.error('Error fetching profile:', profileError);
            try {
              // Fallback to config method if available
              const configSupabase = window.AppConfig?.initSupabase();
              if (configSupabase) {
                const { data: configProfileData } = await configSupabase
                  .from('profiles')
                  .select('is_admin')
                  .eq('id', result.data.user.id)
                  .single();
                  
                profile = configProfileData;
              }
            } catch (e) {
              console.error('Fallback profile fetch failed:', e);
              // Default to non-admin if all profile fetches fail
              location.href = 'home.html';
              return;
            }
          }
          
          // Route based on user role
          if (profile?.is_admin) {
            location.href = 'admin.html';
          } else {
            location.href = 'home.html'; // Non-admin users go to home page
          }
        }
        
      } catch (error) {
        showError('An unexpected error occurred. Please try again.');
        console.error('Auth error:', error);
      } finally {
        // Reset button state
        loginBtn.disabled = false;
        loginBtn.innerHTML = isRegisterMode ? 
          '<span>Register</span>' : 
          '<span class="login-icon" aria-hidden="true"></span><span>Sign In</span>';
      }
    });
    
    // Handle flag clicks for future internationalization
    document.querySelectorAll('.flag').forEach(flag => {
      flag.addEventListener('click', function() {
        const country = this.title;
        console.log(`Selected region: ${country}`);
        // Future: implement language/region switching
      });
    });
    
    // Add some visual feedback
    loginBtn.addEventListener('mousedown', function() {
      if (!this.disabled) {
        this.style.transform = 'translateY(1px)';
      }
    });

    loginBtn.addEventListener('mouseup', function() {
      this.style.transform = '';
    });

    loginBtn.addEventListener('mouseleave', function() {
      this.style.transform = '';
    });
  </script>  

  <!-- Footer -->
  <footer class="alumil-footer">
    <p>Alumil Labeling App @2025</p>
  </footer>

</body>
</html>