<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Profile Label â€“ Print Preview (Free Layout)</title>

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png?v=4">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png?v=4">
  <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg?v=4">
  <link rel="manifest" href="/favicon/site.webmanifest?v=4">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg?v=4" color="#ffc107">
  <link rel="shortcut icon" href="/favicon/favicon.ico?v=4">
  <meta name="msapplication-TileColor" content="#ffc107">
  <meta name="msapplication-config" content="/favicon/browserconfig.xml?v=4">
  <meta name="theme-color" content="#ffc107">
  
  <!-- Tailwind for control bar only -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JsBarcode -->
  <script src="https://unpkg.com/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <!-- Admin via URL (enable: ?admin=1, disable: ?admin=0 or ?admin=clear) -->
  <script>
    (function () {
      try {
        const q = new URLSearchParams(location.search);
        const v = q.get('admin') || q.get('admin1') || q.get('isAdmin');
        if (v !== null) {
          const on  = /^(1|true|yes|on|admin)$/i.test(v);
          const off = /^(0|false|no|off)$/i.test(v) || /^clear$/i.test(v);
          if (on) {
            localStorage.setItem('alumil:role','admin');
            localStorage.setItem('role','admin');
            localStorage.setItem('isAdmin','1');
          } else if (off) {
            localStorage.removeItem('alumil:role');
            localStorage.removeItem('role');
            localStorage.removeItem('isAdmin');
          }
          try { new BroadcastChannel('alumil-cache').postMessage({type:'role-updated'}); } catch(e){}
        }
      } catch(e){}
    })();
  </script>

  <style>
    :root{
      /* Physical label defaults (Portrait 160x110) */
      --label-w-mm: 160;
      --label-h-mm: 110;

      /* Spacing + visual vars */
      --pad-mm: 8;
      --gap-mm: 3;
      --logo-mm: 12;

      /* Barcode */
      --bc-height-px: 52;
      --bc-width-px: 2;

      /* Details text */
      --kv-font-pt: 9;
      --key-w-mm: 28;

      /* Image zoom */
      --img-scale: 1;

      --border: 1px solid #e5e7eb;
      --dash: 1px dashed #e5e7eb;
      --k-color: #374151;
      --v-color: #111827;

      /* Dynamic height of control bar so page can avoid overlap */
      --controls-h: 0px;
    }

    html, body { margin:0; padding:0; background:#111827; color:#e5e7eb; }

    /* Use dynamic viewport height on mobile; fallback to 100vh */
    .page {
      min-height: 100dvh;
      display:grid; place-items:center;
      padding:12px;
      /* make room for fixed controls + notches */
      padding-bottom: calc(12px + var(--controls-h, 0px) + env(safe-area-inset-bottom, 0px));
      box-sizing: border-box;
    }
    @supports not (height: 100dvh) {
      .page { min-height: 100vh; }
    }

    /* Exact physical label */
    .label {
      position: relative; /* for scale overlay */
      background:#fff; color:#111827;
      width: calc(var(--label-w-mm) * 1mm);
      height: calc(var(--label-h-mm) * 1mm);
      border-radius:6px;
      box-shadow:0 12px 24px rgba(0,0,0,.35);
      display:grid;
      grid-template-rows:auto 1fr auto;
      overflow:hidden;
    }

    /* ===== Scale/Ruler around border (toggle with .show-scale on body) ===== */
    .label::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      --scale-color: rgba(239,68,68,0.95);
      color: var(--scale-color);
      background:
        repeating-linear-gradient(to right, currentColor 0 0.2mm, transparent 0.2mm 1mm),
        repeating-linear-gradient(to right, currentColor 0 0.35mm, transparent 0.35mm 10mm),
        repeating-linear-gradient(to right, currentColor 0 0.2mm, transparent 0.2mm 1mm),
        repeating-linear-gradient(to right, currentColor 0 0.35mm, transparent 0.35mm 10mm),
        repeating-linear-gradient(to bottom, currentColor 0 0.2mm, transparent 0.2mm 1mm),
        repeating-linear-gradient(to bottom, currentColor 0 0.35mm, transparent 0.35mm 10mm),
        repeating-linear-gradient(to bottom, currentColor 0 0.2mm, transparent 0.2mm 1mm),
        repeating-linear-gradient(to bottom, currentColor 0 0.35mm, transparent 0.35mm 10mm);
      background-size:
        100% 2mm, 100% 4mm, 100% 2mm, 100% 4mm, 2mm 100%, 4mm 100%, 2mm 100%, 4mm 100%;
      background-position:
        top left, top left, bottom left, bottom left, top left, top left, top right, top right;
      background-repeat:no-repeat;
      outline: 0.3mm solid var(--scale-color);
      outline-offset: -0.15mm;
      display:none;
      z-index: 50;
    }
    .show-scale .label::before{ display:block; }

    /* Header */
    .head {
      display:flex; align-items:center; justify-content:space-between; gap: calc(var(--gap-mm) * 1mm);
      padding: calc(var(--pad-mm) * 1mm);
      padding-bottom: calc((var(--pad-mm) - 2) * 1mm);
      border-bottom: var(--border);
    }
    .brand img { height: calc(var(--logo-mm) * 1mm); width:auto; display:block; }

    .barcode-wrap {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap: 2mm; background:#fff;
      padding: 2mm 3mm; border: var(--dash); border-radius:4px;
      min-width: 45mm; max-width: 90mm;
    }
    .barcode-wrap svg { width:100%; height:auto; }
    .code-under {
      font: 10pt/1.1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:#111827; word-break:break-all; text-align:center;
    }

    /* Body canvas */
    .body {
      position:relative;
      padding: calc(var(--pad-mm) * 1mm);
      padding-top: calc((var(--gap-mm) + 2) * 1mm);
      padding-bottom: 24px; /* reserve space so blocks donâ€™t overlap footer */
      box-sizing: border-box;
    }

    /* Blocks (draggable/resizable) */
    .blk {
      position:absolute;
      border: none;
      background:#ffffff;
      border-radius:6px;
      overflow:hidden;
    }
    .blk .titlebar {
      display:none; /* only visible in edit mode */
      align-items:center; justify-content:space-between;
      padding: 4px 8px; font-size:12px; background:#f3f4f6; color:#111827;
      border-bottom: var(--border);
      cursor:move;
    }
    .blk .content { width:100%; height:100%; }

    /* Photo block */
    .blk-photo .content {
      display:flex; align-items:center; justify-content:center;
      padding:3mm; background:#fff;
      border: 1px solid #e5e7eb; border-radius:6px;
      overflow:hidden;
    }
    .blk-photo img {
      width:100%; height:100%; object-fit:contain; display:block;
      transform: scale(var(--img-scale));               
      transform-origin: center center;
    }

    /* Details block â€” match label page color (white), no box */
    .kv {
      height:100%;
      background:#ffffff;
      display:grid; gap: 2mm; align-content:start;
      padding: 3mm; /* â¬… match photo frame top padding for aligned tops */
      font-size: calc(var(--kv-font-pt) * 1pt);
      border-radius:6px; box-sizing:border-box;
      border: none;
    }
    .row { display:flex; align-items:center; gap: calc(var(--gap-mm) * 1mm); min-width:0; }
    .k { color: var(--k-color); min-width: calc(var(--key-w-mm) * 1mm); }
    .v {
      color: var(--v-color); font-weight:600; flex:1; min-width:0;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    /* ðŸ”¹ Hanging label row (used for Description) */
    .row--hang { position: relative; display:block; min-width:0; }
    .row--hang::before{
      content: attr(data-k);
      position:absolute; left:0; top:0;
      width: calc(var(--key-w-mm) * 1mm);
      color: var(--k-color);
    }
    .row--hang .v{
      display:block;
      white-space:normal;            /* allow wrap */
      overflow:visible;              /* no ellipsis */
      text-overflow:clip;
      line-height:1.2;
      /* indent only the first line by key width + gap so lines 2+ start under the key */
      text-indent: calc((var(--key-w-mm) + var(--gap-mm)) * 1mm);
    }

    /* Resize handle (BR) */
    .handle {
      position:absolute; right:4px; bottom:4px; width:14px; height:14px;
      border-radius:3px; background:#11182710; border:1px solid #cbd5e1; cursor:nwse-resize;
      display:none; /* only in edit mode */
    }

    /* Footer */
    .foot {
      border-top: var(--border);
      padding: calc((var(--gap-mm) + 1) * 1mm) calc(var(--pad-mm) * 1mm) calc(var(--pad-mm) * 1mm);
      display:flex; align-items:center; justify-content:space-between; gap: 4mm;
      font-size: 8.5pt; color:#374151; min-width:0;
    }
    .foot > div { min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* Edit mode visuals */
    .edit .blk { outline: 1px dashed #9ca3af; }
    .edit .blk .titlebar { display:flex; }
    .edit .handle { display:block; }

    /* Print */
    @media print {
      @page { size: var(--page-w) var(--page-h); margin:0; }
      html, body { background:#fff; }
      .controls { display:none !important; }
      .page { padding:0; min-height:auto; }
      .label { box-shadow:none; margin:0 auto; }
      .edit .blk { outline:none; }
      .edit .titlebar, .edit .handle { display:none !important; }
      .label::before { display:none !important; } /* hide scale on print (remove to print it) */
    }

    /* Control bar (admin only) */
    .controls{
      position:fixed; inset-inline:0; bottom:0;
      background:rgba(17,24,39,.92); color:#e5e7eb;
      backdrop-filter:blur(6px);
      border-top:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      z-index: 1000; /* ensure above content */
    }
    .controls.hidden { display:none !important; }
    .controls .inner{
      max-width: 1300px; margin:0 auto; display:flex; flex-wrap:wrap; gap:12px; align-items:center;
    }
    .grp { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .grp label { font-size:12px; color:#cbd5e1; }
    .grp input[type="range"]{ width:140px; }
    .sep { width:1px; height:26px; background:rgba(255,255,255,.12); margin:0 6px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body data-orient="portrait">
  <div class="page">
    <div class="label" aria-label="Printable label">
      <!-- HEADER -->
      <div class="head">
        <div class="brand"><img src="alumil-logo.svg" alt="Alumil"></div>
        <div class="barcode-wrap">
          <svg id="barcode"></svg>
          <div id="code-under" class="code-under">â€”</div>
        </div>
      </div>

      <!-- BODY CANVAS (draggable/resize blocks) -->
      <div id="canvas" class="body">
        <!-- Photo block (left) -->
        <div id="blk-photo" class="blk blk-photo" data-key="photo">
          <div class="titlebar"><span>Image</span></div>
          <div class="content">
            <img id="item-photo" src="https://placehold.co/600x400/ffffff/111111?text=No+Image" alt="Item image">
          </div>
          <div class="handle" title="Resize"></div>
        </div>

        <!-- Details block (right) -->
        <div id="blk-details" class="blk blk-details" data-key="details">
          <div class="titlebar"><span>Details</span></div>
          <div class="content">
            <div class="kv">
              <!-- ðŸ”¹ Description uses hanging-label layout -->
              <div class="row row--hang" data-k="Description"><div id="v-desc" class="v">â€”</div></div>

              <div class="row"><div class="k">Profile Title</div><div id="v-ptitle" class="v">â€”</div></div>
              <div class="row"><div class="k">Alloy</div><div id="v-alloy" class="v">â€”</div></div>
              <div class="row"><div class="k">Finish</div><div id="v-finish" class="v">â€”</div></div>
              <div class="row"><div class="k">Quantity</div><div id="v-qty" class="v">â€”</div></div>
              <div class="row"><div class="k">Length</div><div id="v-length" class="v">â€”</div></div>
              <div class="row"><div class="k">Remarks</div><div id="v-remarks" class="v">â€”</div></div>
              <div class="row"><div class="k">Label Size</div><div id="v-size" class="v">â€”</div></div>
              <div class="row"><div class="k">Generated</div><div id="v-generated" class="v">â€”</div></div>
            </div>
          </div>
          <div class="handle" title="Resize"></div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="foot">
        <div id="foot-left">Alumil Inventory</div>
        <div id="foot-right">â€”</div>
      </div>
    </div>
  </div>

  <!-- CONTROL BAR (admin-only; visibility set in JS) -->
  <div class="controls hidden" id="controlsBar">
    <div class="inner">
      <div class="grp">
        <label>Size (mm)</label>
        <select id="sizeSel" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
          <option value="160x110">160Ã—110</option>
          <option value="150x100">150Ã—100</option>
          <option value="200x150">200Ã—150</option>
          <option value="250x200">250Ã—200</option>
        </select>
        <div class="sep"></div>
        <label>Orientation</label>
        <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="orient" value="portrait" checked> Portrait</label>
        <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="orient" value="landscape"> Landscape</label>
        <div class="sep"></div>
        <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="editToggle"> Free layout (drag/resize)</label>
        <div class="sep"></div>
        <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="scaleToggle"> Show scale border</label>
      </div>

      <div class="sep"></div>

      <div class="grp">
        <label>Barcode height</label>
        <input id="bcH" type="range" min="36" max="90" step="2" value="52" title="px">
        <label>Barcode thickness</label>
        <input id="bcW" type="range" min="1" max="4" step="0.2" value="2" title="px">
        <label>Logo height</label>
        <input id="logoH" type="range" min="8" max="18" step="0.5" value="12" title="mm">
        <label>Details font</label>
        <input id="kvFont" type="range" min="8" max="12" step="0.5" value="9" title="pt">
        <label>Key width</label>
        <input id="keyW" type="range" min="20" max="50" step="1" value="28" title="mm">
        <label>Padding</label>
        <input id="pad" type="range" min="5" max="14" step="0.5" value="8" title="mm">
        <label>Gaps</label>
        <input id="gap" type="range" min="2" max="6" step="0.5" value="3" title="mm">
        <div class="sep"></div>
        <!-- NEW: Image Zoom inside preview frame -->
        <label>Image zoom</label>
        <input id="imgZoom" type="range" min="0.5" max="3" step="0.05" value="1" title="Ã—">
      </div>

      <div class="flex-1"></div>

      <div class="grp">
        <button id="btnReload" class="px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 text-sm">Reload Data</button>
        <button id="btnResetBlocks" class="px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 text-sm">Reset Blocks</button>
        <button id="btnResetAll" class="px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 text-sm">Reset All</button>
        <button id="btnPrint" class="px-3 py-1.5 rounded bg-amber-500 text-black font-semibold text-sm">Print</button>
      </div>
    </div>
  </div>

  <script>
    /* ================== Admin gate ================== */
    function isAdmin(){
      try {
        const r1 = (localStorage.getItem('alumil:role')||'').toLowerCase();
        const r2 = (localStorage.getItem('role')||'').toLowerCase();
        const r3 = (localStorage.getItem('isAdmin')||'').toString();
        return r1==='admin' || r2==='admin' || r3==='1';
      } catch { return false; }
    }
    function setControlsVisibility(){
      const bar = document.getElementById('controlsBar');
      const admin = isAdmin();
      if (admin){
        bar.classList.remove('hidden');
      } else {
        bar.classList.add('hidden');
        document.body.classList.remove('edit');           
        document.documentElement.style.setProperty('--controls-h','0px');
      }
      return admin;
    }

    /* ================== Payload & size ================== */
    function getPayload(){ try{ const raw = localStorage.getItem('profilePrintData'); return raw ? JSON.parse(raw) : {}; } catch{ return {}; } }
    function parseSize(str, fallback="160x110"){
      const t = (str || fallback).trim().toLowerCase();
      const m = t.match(/^(\d+(?:\.\d+)?)x(\d+(?:\.\d+)?)$/);
      if (!m) return {w:160, h:110, label:"160x110"};
      return {w:+m[1], h:+m[2], label:`${+m[1]}x${+m[2]}`};
    }
    function applyPaper(sizeStr, orientation){
      const {w,h,label} = parseSize(sizeStr);
      const isLand = orientation === 'landscape';
      const W = isLand ? Math.max(w,h) : Math.min(w,h);
      const H = isLand ? Math.min(w,h) : Math.max(w,h);

      document.documentElement.style.setProperty('--label-w-mm', W);
      document.documentElement.style.setProperty('--label-h-mm', H);
      document.body.setAttribute('data-orient', orientation);

      let s = document.getElementById('page-size-style');
      if(!s){ s = document.createElement('style'); s.id='page-size-style'; document.head.appendChild(s); }
      s.textContent = `@page{ size:${W}mm ${H}mm; margin:0; }`;

      localStorage.setItem('profilePreview:size', label);
      localStorage.setItem('profilePreview:orient', orientation);
      const vsize = document.getElementById('v-size'); if (vsize) vsize.textContent = `${W} Ã— ${H} mm (${orientation})`;
    }

    /* ================== Style knobs ================== */
    function setVar(name, value){ document.documentElement.style.setProperty(name, value); localStorage.setItem('ppv:'+name, value); }
    function loadVar(name, def){ const v = localStorage.getItem('ppv:'+name); document.documentElement.style.setProperty(name, v ?? def); }
    function renderBarcode(value){
      const width = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bc-width-px')) || 2;
      const height = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bc-height-px')) || 52;
      try{
        JsBarcode("#barcode", value || "-", { format:"code128", lineColor:"#111827", width, height, displayValue:false, margin:4 });
      }catch(e){
        const bc = document.getElementById('barcode');
        bc.replaceWith(Object.assign(document.createElement('div'), {textContent:'BARCODE', style:'font:12px monospace;'}));
      }
    }

    /* ================== Fill label ================== */
    function fillFromPayload(p){
      p = p || {};
      const code = (p.code||'').trim();
      const desc = (p.description||'').trim();
      const ptitle = (p.profileTitle||'').trim();

      const alloy = (p.alloy||'').trim();
      const finish = (p.finish||'').trim();
      const qty = (p.quantityText || p.qty || '').toString().trim();
      const length = (p.lengthText || p.length || '').toString().trim();
      const barcode = (p.barcode||code||'').trim();
      const remarks = (p.remarks||'').trim();
      const img = (p.image||'').trim();

      const ph = 'https://placehold.co/600x400/ffffff/111111?text=No+Image';
      const im = document.getElementById('item-photo');
      im.referrerPolicy = 'no-referrer';
      im.onerror = ()=> im.src = ph;
      im.src = img || ph;

      const set = (id, val)=>{ const el = document.getElementById(id); if (el) el.textContent = val || 'â€”'; };
      set('v-desc', desc);
      set('v-ptitle', ptitle);
      set('v-alloy', alloy);
      set('v-finish', finish);
      set('v-qty', qty);
      set('v-length', length);
      set('v-remarks', remarks);
      set('foot-right', desc);
      set('code-under', code);

      renderBarcode(barcode);

      // Size/orientation: prefer last saved, else payload.labelSize
      const sel = document.getElementById('sizeSel');
      const payloadSize = (p.labelSize || '').trim();
      const savedSize = localStorage.getItem('profilePreview:size') || payloadSize || '160x110';
      const savedOrient = localStorage.getItem('profilePreview:orient') || 'portrait';
      if (sel) sel.value = savedSize;
      const r = document.querySelector(`input[name="orient"][value="${savedOrient}"]`); if (r) r.checked = true;
      applyPaper(savedSize, savedOrient);

      const gen = document.getElementById('v-generated'); if (gen) gen.textContent = new Date().toLocaleString(undefined, {hour12:false});
    }

    /* ================== Free layout (drag/resize) ================== */
    const CANVAS_KEY = 'ppv:blocks';
    function pct(n, total){ return Math.max(0, Math.min(100, (n/total)*100)); }
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    const DEFAULT_BLOCKS = {
      photo:  { x: 2,  y: 2,  w: 32, h: 70 },
      details:{ x: 36, y: 2,  w: 62, h: 96 },
    };

    function loadBlocks(){
      try{ const raw = localStorage.getItem(CANVAS_KEY); if(raw){ return {...DEFAULT_BLOCKS, ...JSON.parse(raw)}; } }
      catch{}
      return {...DEFAULT_BLOCKS};
    }
    function saveBlocks(state){ try{ localStorage.setItem(CANVAS_KEY, JSON.stringify(state)); }catch{} }

    function applyBlockRects(state){
      function place(el, cfg){
        el.style.left   = cfg.x + '%';
        el.style.top    = cfg.y + '%';
        el.style.width  = cfg.w + '%';
        el.style.height = cfg.h + '%';
      }
      place(document.getElementById('blk-photo'),   state.photo);
      place(document.getElementById('blk-details'), state.details);
    }

    function enableEditMode(on){ document.body.classList.toggle('edit', !!on); }

    function bindDragResize(blockId, state, onChange){
      const el = document.getElementById(blockId);
      const canvas = document.getElementById('canvas');
      const handle = el.querySelector('.handle');
      const bar = el.querySelector('.titlebar');

      let dragging=false, resizing=false;
      let startX=0, startY=0, startRect=null, canvasRect=null, safePct=0;

      function computeSafePct(){
        const style = getComputedStyle(canvas);
        const pb = parseFloat(style.paddingBottom) || 0;
        const rect = canvas.getBoundingClientRect();
        return rect.height ? (pb / rect.height) * 100 : 0;
      }

      function startDrag(e){
        if (!document.body.classList.contains('edit')) return;
        dragging=true; resizing=false;
        canvasRect = canvas.getBoundingClientRect();
        safePct = computeSafePct();
        startX = (e.touches?e.touches[0].clientX:e.clientX);
        startY = (e.touches?e.touches[0].clientY:e.clientY);
        const {left,top,width,height} = el.getBoundingClientRect();
        startRect = {left,top,width,height};
        e.preventDefault();
      }
      function startResize(e){
        if (!document.body.classList.contains('edit')) return;
        resizing=true; dragging=false;
        canvasRect = canvas.getBoundingClientRect();
        safePct = computeSafePct();
        startX = (e.touches?e.touches[0].clientX:e.clientX);
        startY = (e.touches?e.touches[0].clientY:e.clientY);
        const {left,top,width,height} = el.getBoundingClientRect();
        startRect = {left,top,width,height};
        e.preventDefault();
        e.stopPropagation();
      }
      function move(e){
        if (!dragging && !resizing) return;
        const x = (e.touches?e.touches[0].clientX:e.clientX);
        const y = (e.touches?e.touches[0].clientY:e.clientY);
        const dx = x - startX;
        const dy = y - startY;

        const cur = state[el.dataset.key];
        if (dragging){
          const nx = pct(startRect.left - canvasRect.left + dx, canvasRect.width);
          const ny = pct(startRect.top  - canvasRect.top  + dy, canvasRect.height);
          cur.x = clamp(nx, 0, 100 - cur.w);
          cur.y = clamp(ny, 0, 100 - cur.h - safePct);
        } else if (resizing){
          const nw = pct(startRect.width  + dx, canvasRect.width);
          const nh = pct(startRect.height + dy, canvasRect.height);
          cur.w = clamp(nw, 10, 100 - cur.x);
          cur.h = clamp(nh, 10, 100 - cur.y - safePct);
        }
        applyBlockRects(state);
        onChange(state);
      }
      function end(){ dragging=false; resizing=false; }

      bar.addEventListener('mousedown', startDrag);
      bar.addEventListener('touchstart', startDrag, {passive:false});
      handle.addEventListener('mousedown', startResize);
      handle.addEventListener('touchstart', startResize, {passive:false});
      window.addEventListener('mousemove', move);
      window.addEventListener('touchmove', move, {passive:false});
      window.addEventListener('mouseup', end);
      window.addEventListener('touchend', end);
    }

    /* ========= Controls height â†’ page padding (prevents overlap) ========= */
    function updateControlsHeight(){
      const c = document.getElementById('controlsBar');
      const h = (!c || c.classList.contains('hidden')) ? 0 : c.offsetHeight;
      document.documentElement.style.setProperty('--controls-h', h + 'px');
    }

    function bindViewportListeners(){
      updateControlsHeight();
      window.addEventListener('resize', updateControlsHeight);
      window.addEventListener('orientationchange', updateControlsHeight);
      if (window.visualViewport){
        visualViewport.addEventListener('resize', updateControlsHeight);
        visualViewport.addEventListener('scroll', updateControlsHeight);
      }
    }

    /* ============== Init ============== */
    function loadSavedVars(){
      ['--kv-font-pt','--key-w-mm','--bc-height-px','--bc-width-px','--logo-mm','--pad-mm','--gap-mm','--img-scale']
        .forEach(name => {
          const def = getComputedStyle(document.documentElement).getPropertyValue(name);
          loadVar(name, def);
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const admin = setControlsVisibility();
      bindViewportListeners();

      loadSavedVars();

      if (admin){
        const bindVar = (id, varName, unit='')=>{
          const el = document.getElementById(id);
          el.value = (localStorage.getItem('ppv:'+varName) ?? getComputedStyle(document.documentElement).getPropertyValue(varName)).replace(unit,'').trim();
          el.addEventListener('input', ()=>{
            setVar(varName, el.value + unit);
            if (varName==='--bc-height-px' || varName==='--bc-width-px'){
              const p = getPayload(); renderBarcode((p.barcode || p.code || '-').trim());
              updateControlsHeight();
            }
          });
        };
        bindVar('kvFont','--kv-font-pt');
        bindVar('keyW',  '--key-w-mm');
        bindVar('bcH',   '--bc-height-px');
        bindVar('bcW',   '--bc-width-px');
        bindVar('logoH', '--logo-mm');
        bindVar('pad',   '--pad-mm');
        bindVar('gap',   '--gap-mm');
        bindVar('imgZoom','--img-scale');
      }

      const sel = document.getElementById('sizeSel');
      const savedSize = localStorage.getItem('profilePreview:size') || '160x110';
      const savedOrient = localStorage.getItem('profilePreview:orient') || 'portrait';
      if (sel) sel.value = savedSize;
      const r = document.querySelector(`input[name="orient"][value="${savedOrient}"]`); if (r) r.checked = true;
      applyPaper(savedSize, savedOrient);

      if (admin){
        sel.addEventListener('change', (e)=>{
          const size = e.target.value;
          const orient = document.querySelector('input[name="orient"]:checked').value;
          applyPaper(size, orient);
        });
        document.querySelectorAll('input[name="orient"]').forEach(r=>{
          r.addEventListener('change', ()=>{
            const size = document.getElementById('sizeSel').value;
            const orient = document.querySelector('input[name="orient"]:checked').value;
            applyPaper(size, orient);
          });
        });
      }

      fillFromPayload(getPayload());

      let blocks = loadBlocks();
      applyBlockRects(blocks);

      (function reclampInitial(){
        const canvas = document.getElementById('canvas');
        const style = getComputedStyle(canvas);
        const pb = parseFloat(style.paddingBottom) || 0;
        const rect = canvas.getBoundingClientRect();
        const safePct = rect.height ? (pb / rect.height) * 100 : 0;
        ['photo','details'].forEach(k=>{
          const b = blocks[k];
          b.y = clamp(b.y, 0, 100 - b.h - safePct);
          b.h = clamp(b.h, 10, 100 - b.y - safePct);
        });
        applyBlockRects(blocks);
        saveBlocks(blocks);
      })();

      if (admin){
        bindDragResize('blk-photo', blocks, (s)=> saveBlocks(s));
        bindDragResize('blk-details', blocks, (s)=> saveBlocks(s));
      }

      const editToggle = document.getElementById('editToggle');
      if (admin){
        editToggle.checked = (localStorage.getItem('ppv:edit') === '1');
        enableEditMode(editToggle.checked);
        editToggle.addEventListener('change', ()=>{
          enableEditMode(editToggle.checked);
          localStorage.setItem('ppv:edit', editToggle.checked ? '1' : '0');
        });
      } else {
        enableEditMode(false);
        if (editToggle) editToggle.disabled = true;
        const scaleToggle = document.getElementById('scaleToggle');
        if (scaleToggle) scaleToggle.disabled = true;
      }

      const scaleToggle = document.getElementById('scaleToggle');
      const savedScale = localStorage.getItem('ppv:scale') === '1';
      document.body.classList.toggle('show-scale', savedScale);
      if (admin){
        scaleToggle.checked = savedScale;
        scaleToggle.addEventListener('change', ()=>{
          document.body.classList.toggle('show-scale', scaleToggle.checked);
          localStorage.setItem('ppv:scale', scaleToggle.checked ? '1' : '0');
        });
      }

      document.getElementById('btnReload').addEventListener('click', ()=> fillFromPayload(getPayload()));
      document.getElementById('btnPrint').addEventListener('click', ()=> window.print());

      if (admin){
        document.getElementById('btnResetBlocks').addEventListener('click', ()=>{
          blocks = {...DEFAULT_BLOCKS};
          applyBlockRects(blocks);
          saveBlocks(blocks);
        });

        document.getElementById('btnResetAll').addEventListener('click', ()=>{
          ['--kv-font-pt','--key-w-mm','--bc-height-px','--bc-width-px','--logo-mm','--pad-mm','--gap-mm','--img-scale']
            .forEach(name => localStorage.removeItem('ppv:'+name));
          localStorage.removeItem(CANVAS_KEY);
          localStorage.removeItem('ppv:edit');
          localStorage.removeItem('profilePreview:size');
          localStorage.removeItem('profilePreview:orient');
          localStorage.removeItem('ppv:scale');
          location.reload();
        });
      } else {
        ['btnResetBlocks','btnResetAll'].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
      }

      updateControlsHeight();
    });
  </script>

<script>
// Versioned global bootstrap (SharePoint + Config)
document.addEventListener('DOMContentLoaded', async () => {
  const BASE = "https://alumildxb-my.sharepoint.com/:x:/g/personal/a_olivero_alumil_ae/EVlOY6zQ8SRJmM9696IevO8BpoiOXwkzFe88_yRNe2kC2A?e=tfIbS3";
  async function j(u){
  // If we're pointing at a SharePoint Excel link, emulate the old JSON API:
  if ((typeof BASE === "string") && BASE.includes("sharepoint.com")) {
    // Ensure loader + workbook
    if (typeof loadWorkbook !== "function") {
      throw new Error("XLSX loader not found. Ensure xlsx.full.min.js and js/sharepoint_loader.js are loaded.");
    }
    if (!window.__SP_WB_LOADED__) {
      await loadWorkbook(BASE);
      window.__SP_WB_LOADED__ = true;
    }
    // Extract sheet=Name from the URL and return rows from that sheet
    try {
      const qs = (u.split("?")[1] || "");
      const params = new URLSearchParams(qs);
      const sheet = params.get("sheet") || "Config";
      const rows = getSheetJSON(sheet);
      return rows || [];
    } catch (e) {
      console.error("SharePoint sheet load failed:", e);
      return [];
    }
  }

  // Fallback: original JSON fetch behavior
  const r = await fetch(u, {mode:'cors'});
  if(!r.ok) throw 0;
  return r.json();
}

); if(!r.ok) throw 0; return r.json(); }

  // 1) Local cache + version
  let local = {}, localVersion = null;
  try { local = JSON.parse(localStorage.getItem('excelCache') || '{}'); localVersion = local?.version || null; } catch { local = {}; }

  // 2) Remote config (version, sheet names)
  let cfg = { version: null, sheetProfiles: "Profile", sheetAccessories: "Accessories" };
  try {
    const rows = await j(BASE + (BASE.includes('?')?'&':'?') + 'sheet=Config');
    const map = Object.fromEntries((rows || []).filter(r => r && r.key).map(r => [r.key, r.value]));
    cfg = Object.assign(cfg, map);
  } catch (_){
    // no Config found -> force refresh
  }

  const remoteVersion = cfg.version || null;
  const hasData = (Array.isArray(local?.profiles) && local.profiles.length) || (Array.isArray(local?.accessories) && local.accessories.length);

  // 3) If same version and have data -> keep cache
  if (remoteVersion && localVersion && remoteVersion === localVersion && hasData) return;

  // 4) Fetch fresh data from configured sheets
  try {
    const urlP = BASE + (BASE.includes('?')?'&':'?') + 'sheet=' + encodeURIComponent(cfg.sheetProfiles || 'Profile');
    const urlA = BASE + (BASE.includes('?')?'&':'?') + 'sheet=' + encodeURIComponent(cfg.sheetAccessories || 'Accessories');
    const [p, a] = await Promise.all([ j(urlP), j(urlA) ]);
    const profiles = Array.isArray(p) ? p : (p?.data || []);
    const accessories = Array.isArray(a) ? a : (a?.data || []);

    localStorage.setItem('excelCache', JSON.stringify({
      profiles, accessories,
      version: remoteVersion,
      fileName: `SharePoint: ${cfg.sheetProfiles} + ${cfg.sheetAccessories}`,
      loadedAt: new Date().toISOString()
    }));
    console.log('[bootstrap] excelCache updated to version', remoteVersion);
  } catch (e) {
    console.warn('Versioned bootstrap failed:', e);
  }
});
</script>

  <script src="js/sharepoint_loader.js"></script>
</body>
</html>
