<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Label 1 – Print</title>

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png?v=5">
<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png?v=5">
<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png?v=5">
<link rel="icon" type="image/svg+xml" href="favicon/favicon.svg?v=5">
<link rel="manifest" href="favicon/site.webmanifest?v=5">
<link rel="mask-icon" href="favicon/safari-pinned-tab.svg?v=5" color="#ffc107">
<link rel="shortcut icon" href="favicon/favicon.ico?v=5">
<meta name="msapplication-TileColor" content="#ffc107">
<meta name="msapplication-config" content="favicon/browserconfig.xml?v=5">
<meta name="theme-color" content="#ffc107">

<style>
  /* ---------- Size & base ---------- */
  @page { size: 160mm 110mm; margin: 4mm; }
  :root{
    --w:160mm; --h:110mm;
    --pad:4mm;
    --gap:4mm;
    --radius:3mm;
    --line:#C8D1DC;
    --muted:#5D6B7C;
    --text:#0F172A;
    --card:#F8FAFC;
  }
  html,body{ height:100%; }
  body{
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
    margin:0; background:#fff; color:var(--text);
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
  }
  .label{
    width:var(--w); height:var(--h);
    box-sizing:border-box;
    padding:var(--pad);
    display:grid; grid-template-columns: 62mm 1fr; gap:var(--gap);
    border:1px dashed var(--line);
  }

  /* ---------- Left: image panel ---------- */
  .imgPanel{
    border:1px solid var(--line); border-radius:var(--radius);
    display:grid; grid-template-rows:auto 1fr;
    background:#fff; padding:3mm; gap:3mm;
    min-height:0;
  }
  .imgPanel h4{ margin:0; color:var(--muted); font-size:10px; font-weight:600; }
  .imgBox{
    min-height:0;
    display:grid; place-items:center;
    background:#fff; border-radius:2mm;
    border:1px dashed var(--line);
    overflow:hidden;
  }
  .imgBox img{
    max-width:100%; max-height:100%;
    object-fit:contain; image-rendering:auto;
    display:block;
  }

  /* ---------- Right: content ---------- */
  .right{
    display:grid; grid-template-rows:auto 1fr;
    min-width:0;
  }

  /* Top grid: Description + Title full width; the rest two columns */
  .topGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    column-gap:6mm; row-gap:3.5mm;
    align-content:start;
  }
  .row{ display:grid; grid-template-columns: 26mm 1fr; column-gap:3mm; align-items:start; }
  .row.span2{ grid-column: 1 / -1; } /* full width row */
  .k{ color:var(--muted); font-size:11px; line-height:1.15; white-space:nowrap; }
  .v{ font-weight:800; font-size:14px; line-height:1.22; word-break:break-word; }

  /* Stacked boxes for Sides and Polyamide */
  .stack{ display:grid; grid-auto-rows:min-content; row-gap:3mm; margin-top:5mm; }
  .box{
    border:1px solid var(--line); border-radius:var(--radius);
    background:var(--card); padding:3mm;
  }
  .box h4{ margin:0 0 2mm 0; color:var(--muted); font-size:10px; }

  /* Pills (used by both Sides and Polyamide) */
  .pillWrap{ display:flex; flex-wrap:wrap; gap:2.5mm; }
  .pill{
    display:flex; align-items:center; gap:2mm;
    padding:2mm 2.8mm;
    border:1px solid var(--line); background:#fff;
    border-radius:999px;
    max-width:100%;
  }
  .pill .pk{
    font-size:10px; color:var(--muted);
    padding-right:2mm; border-right:1px solid var(--line);
    white-space:nowrap;
  }
  .pill .pv{
    font-weight:800; font-size:12.5px; line-height:1.15;
    word-break:break-word; white-space:normal;
  }

  /* Print helper buttons */
  .actions{ position:fixed; right:10px; top:10px; display:flex; gap:8px; }
  .actions button{
    padding:6px 10px; border:1px solid var(--line); background:#fff; border-radius:8px; cursor:pointer;
  }
  @media print { .actions{ display:none; } .label{ border:none; } }
</style>
  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="actions">
  <button onclick="window.print()">Print</button>
  <button onclick="window.close()">Close</button>
</div>

<section class="label" id="label">
  <!-- LEFT: IMAGE -->
  <div class="imgPanel" id="imgPanel">
    <h4>Profile Image</h4>
    <div class="imgBox" id="imgBox">
      <img id="img" alt="" />
    </div>
  </div>

  <!-- RIGHT: DETAILS -->
  <div class="right">
    <!-- Top rows -->
    <div class="topGrid">
      <!-- FULL-WIDTH rows (NO CLAMP) -->
      <div class="row span2">
        <div class="k">Description</div>
        <div class="v" id="desc">—</div>
      </div>
      <div class="row span2">
        <div class="k">Profile Title</div>
        <div class="v" id="ptitle">—</div>
      </div>

      <!-- Two-column rows -->
      <div class="row" id="row-system">
        <div class="k">System</div>
        <div class="v" id="system">—</div>
      </div>
      <div class="row" id="row-alloy">
        <div class="k">Alloy</div>
        <div class="v" id="alloy">—</div>
      </div>
      <div class="row">
        <div class="k">Length</div>
        <div class="v" id="length">—</div>
      </div>
      <div class="row">
        <div class="k">Warehouse No</div>
        <div class="v" id="wh">—</div>
      </div>
      <div class="row">
        <div class="k">Rack No</div>
        <div class="v" id="rack">—</div>
      </div>
    </div>

    <!-- Stacked: Sides (pill) then Polyamide (pill) -->
    <div class="stack">
      <div class="box" id="block-sides" hidden>
        <h4>Sides (1–4)</h4>
        <div class="pillWrap" id="sides"></div>
      </div>
      <div class="box" id="block-poly" hidden>
        <h4>Polyamide (1–6)</h4>
        <div class="pillWrap" id="polys"></div>
      </div>
    </div>
  </div>
</section>

<script>
  const $ = (id)=>document.getElementById(id);

  // Treat placeholders as empty: '', 0, 0.0, '-', '—', '–', 'null', 'undefined', 'n/a'
  function isNoValue(v){
    let t = (v == null ? '' : String(v)).trim();
    if (t === '') return true;
    // normalize different dashes to '-'
    t = t.replace(/[–—]/g, '-');
    const lower = t.toLowerCase();
    if (lower === '-' || lower === '—' || lower === 'na' || lower === 'n/a' || lower === 'null' || lower === 'undefined') return true;
    if (/^0(?:\.0+)?$/.test(t)) return true;
    return false;
  }

  function qsBool(name){
    const v = new URLSearchParams(location.search).get(name);
    return v === '1' || v === 'true';
  }

  function readPayload(){
    try{
      const q = new URLSearchParams(location.search);
      const enc = q.get('data');
      if(!enc) return null;
      return JSON.parse(decodeURIComponent(escape(atob(enc))));
    }catch(e){ return null; }
  }

  function fillText(id, value){
    const el = $(id);
    if(!el) return;
    el.textContent = isNoValue(value) ? '—' : String(value);
  }

  function setImage(src){
    const img = $('img');
    const imgBox = $('imgBox');
    const imgPanel = $('imgPanel');
    if(!isNoValue(src)){
      img.onload  = ()=>{ imgBox.hidden = false; imgPanel.hidden = false; };
      img.onerror = ()=>{ imgBox.hidden = true; };
      img.src = src;
    }else{
      imgBox.hidden = true;
      imgPanel.hidden = true;
    }
  }

  function render(payload){
    // Top fields
    fillText('desc',   payload.description);
    fillText('ptitle', payload.profile_title);

    // Two-column fields
    fillText('system', payload.system);

    // Alloy: hide the whole row if placeholder/zero
    const alloyRow = $('row-alloy');
    if (isNoValue(payload.alloy)) {
      alloyRow.hidden = true;
    } else {
      alloyRow.hidden = false;
      fillText('alloy', payload.alloy);
    }

    // These should always render even if '0'
    $('length').textContent = (payload.length ?? '') === '' ? '—' : String(payload.length);
    $('wh').textContent     = (payload.warehouse_no ?? '') === '' ? '—' : String(payload.warehouse_no);
    $('rack').textContent   = (payload.rack_no ?? '') === '' ? '—' : String(payload.rack_no);

    // Image
    setImage(payload.image);

    // Sides -> pills (skip placeholders entirely)
    const sidesWrap = $('block-sides');
    const sidesRow  = $('sides');
    let anySide = false; sidesRow.innerHTML = '';
    [1,2,3,4].forEach(i=>{
      const v = payload.sides ? payload.sides[String(i)] : undefined;
      if (!isNoValue(v)){
        const d = document.createElement('div'); d.className = 'pill';
        d.innerHTML = `<span class="pk">S${i}</span><span class="pv">${String(v)}</span>`;
        sidesRow.appendChild(d); anySide = true;
      }
    });
    sidesWrap.hidden = !anySide;

    // Polyamide -> pills (skip placeholders entirely)
    const polyWrap = $('block-poly');
    const polysRow = $('polys');
    let anyPoly = false; polysRow.innerHTML = '';
    [1,2,3,4,5,6].forEach(i=>{
      const v = payload.polyamide ? payload.polyamide[String(i)] : undefined;
      if (!isNoValue(v)){
        const d = document.createElement('div'); d.className = 'pill';
        d.innerHTML = `<span class="pk">PA${i}</span><span class="pv">${String(v)}</span>`;
        polysRow.appendChild(d); anyPoly = true;
      }
    });
    polyWrap.hidden = !anyPoly;
  }

  // Boot
  const payload = readPayload();
  if (payload){ render(payload); }
  if (qsBool('autoprint')) {
    window.addEventListener('load', ()=> setTimeout(()=> window.print(), 150));
  }
</script>

<!-- MARKER: Alumil Mobile Bottom Nav + Footer (v1) -->
<div id="alumil-bottom-safe-pad" style="height: calc(88px + env(safe-area-inset-bottom, 0px));"></div>
<nav id="alumil-bottom-nav" aria-label="Primary" class="alumil-bottom-nav">
  <button class="nav-btn" data-nav="home" onclick="location.href='home.html'" aria-label="Home">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home">
      <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
      <polyline points="9 22 9 12 15 12 15 22"/>
    </svg>
    <span>Home</span>
  </button>
  <button class="nav-btn" data-nav="admin" onclick="location.href='admin.html'" aria-label="Admin">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2">
      <path d="M20 7h-9"/>
      <path d="M14 17h-5"/>
      <circle cx="17" cy="17" r="3"/>
      <circle cx="7" cy="7" r="3"/>
    </svg>
    <span>Admin</span>
  </button>
  <button id="alumil-scan-btn" class="scan-btn" aria-label="Barcode scan (open)">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-line">
      <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
      <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
      <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
      <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
    </svg>
  </button>
  <button class="nav-btn" data-nav="rack" onclick="location.href='rack-label-printing.html'" aria-label="Rack Label">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package">
      <path d="m7.5 4.27 9 5.15"/>
      <path d="M21 8.24v9.42a2 2 0 0 1-1 .51l-8 2.8a2 2 0 0 1-2 0l-8-2.8a2 2 0 0 1-1-.51V8.24a2 2 0 0 1 1-.51l8-2.8a2 2 0 0 1 2 0l8 2.8a2 2 0 0 1 1 .51Z"/>
      <path d="m3.29 7.39 8.31 3.23"/>
      <path d="m12 22.95 8.71-3.26"/>
    </svg>
    <span>Rack Label</span>
  </button>
  <button class="nav-btn" data-nav="search" onclick="location.href='search-inventory.html'" aria-label="Search Inventory">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.3-4.3"/>
    </svg>
    <span>Search</span>
  </button>
<style media="print">
  /* Hide mobile chrome on print */
  #alumil-bottom-safe-pad,
  #alumil-bottom-nav,
  #alumil-fixed-footer,
  #alumil-scan-input,
  #alumil-scan-toast {
    display: none !important;
  }
</style>
</nav>
<footer id="alumil-fixed-footer" class="alumil-footer" role="contentinfo">
  <small>Alumil Inventory App @2025</small>
</footer>
<input id="alumil-scan-input" type="text" inputmode="none" autocomplete="off" autocapitalize="off" spellcheck="false" aria-hidden="true" class="alumil-scan-input" />
<style>
  .alumil-bottom-nav {
    position: fixed; left: 0; right: 0;
    bottom: calc(28px + env(safe-area-inset-bottom, 0px));
    margin: 0 auto; z-index: 60;
    display: grid; grid-template-columns: 1fr 1fr auto 1fr 1fr;
    align-items: center; max-width: 720px;
    padding: 10px 12px;
    background: rgba(15, 23, 42, .92); color: #e5e7eb;
    border: 1px solid rgba(255,255,255,.08); border-radius: 16px;
    backdrop-filter: blur(10px) saturate(140%); -webkit-backdrop-filter: blur(10px) saturate(140%);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  html[data-theme="light"] .alumil-bottom-nav { background: rgba(255,255,255,.96); color:#111827; border-color: rgba(0,0,0,.06); }
  .alumil-bottom-nav .nav-btn { display: inline-flex; flex-direction: column; align-items: center; gap: 4px; background: transparent; border:0; color: inherit; font-weight: 600; font-size: 12px; padding: 6px 8px; border-radius: 10px; }
  .alumil-bottom-nav .nav-btn i { width: 22px; height: 22px; display:inline-block; }
  .alumil-bottom-nav .nav-btn:hover { background: rgba(255,255,255,.06); }
  html[data-theme="light"] .alumil-bottom-nav .nav-btn:hover { background: rgba(0,0,0,.04); }
  .scan-btn { position: relative; width: 56px; height: 56px; display: inline-grid; place-items: center; border-radius: 14px; border: 0; background: #facc15; color: #111827; box-shadow: 0 0 0 0 rgba(250,204,21,0); transition: transform .15s, box-shadow .2s; }
  .scan-btn:hover { transform: translateY(-1px); box-shadow: 0 0 0 8px rgba(250,204,21,.2); }
  .scan-btn:active { transform: translateY(0); }
  .scan-btn i { width: 28px; height: 28px; }
  .alumil-footer { position: fixed; left:0; right:0; bottom: 0; z-index: 50; display:flex; align-items:center; justify-content:center; min-height: 24px; background: #0b1220; color:#cbd5e1; border-top: 1px solid rgba(255,255,255,.08); padding-bottom: env(safe-area-inset-bottom, 0px); font-size: 12px; letter-spacing: .02em; }
  html[data-theme="light"] .alumil-footer { background:#f8fafc; color:#334155; border-top-color: rgba(0,0,0,.06); }
  @media (min-width: 1025px) { #alumil-bottom-safe-pad, #alumil-bottom-nav, #alumil-fixed-footer { display: none !important; } }
  .alumil-scan-input { position: fixed; left: -9999px; width: 1px; height: 1px; opacity: 0; }
</style>
<script>
(function(){
  function routeByCode(raw){
    if(!raw) return;
    const code = String(raw).trim();
    if(!code) return;
    const isAcc = /(\bACC\b|^ACC-|ACC\d|ACCESS|ACCS)/i.test(code);
    const target = isAcc ? 'acc-label-printing.html' : 'profile-label-printing.html';
    const url = target + '?code=' + encodeURIComponent(code);
    window.location.href = url;
  }
  // Keyboard wedge capture
  (function(){
    let buf = '', last = 0;
    window.addEventListener('keydown', (e) => {
      const now = Date.now();
      if(now - last > 250) buf = '';
      last = now;
      if(e.key === 'Enter'){
        if(buf.length >= 4){ routeByCode(buf); }
        buf = ''; return;
      }
      if(e.ctrlKey || e.metaKey || e.altKey) return;
      if(e.key && e.key.length === 1){ buf += e.key; }
    }, true);
  })();
  // Hidden input focus via big button
  const scanBtn = document.getElementById('alumil-scan-btn');
  const scanInput = document.getElementById('alumil-scan-input');
  if(scanBtn && scanInput){
    scanBtn.addEventListener('click', () => {
      scanInput.value = ''; scanInput.focus();
      try {
        if(!document.getElementById('alumil-scan-toast')){
          const t = document.createElement('div');
          t.id = 'alumil-scan-toast';
          t.textContent = 'Ready to scan… (press Enter when done)';
          t.style.position='fixed'; t.style.left='50%'; t.style.bottom='90px'; t.style.transform='translateX(-50%)';
          t.style.background='rgba(0,0,0,.72)'; t.style.color='#fff'; t.style.font='600 12px/1.1 Inter,system-ui';
          t.style.padding='8px 12px'; t.style.borderRadius='10px'; t.style.zIndex=80;
          document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 2000);
        }
      } catch(e){}
    });
    scanInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        routeByCode(scanInput.value);
        scanInput.blur();
      }
    });
  }
  // Active tab highlight
  try{
    const here = location.pathname.split('/').pop().toLowerCase();
    document.querySelectorAll('#alumil-bottom-nav .nav-btn').forEach(btn => {
      const k = btn.getAttribute('data-nav'); if(!k) return;
      const map = { home:'home.html', admin:'admin.html', rack:'rack-label-printing.html', search:'search-inventory.html' };
      if(map[k] && here === map[k].toLowerCase()){ btn.style.fontWeight='800'; btn.style.opacity='1'; }
      else { btn.style.opacity='.85'; }
    });
  }catch(e){}
})();
</script>


<script>
// Versioned global bootstrap (SharePoint + Config)
document.addEventListener('DOMContentLoaded', async () => {
  const BASE = "https://alumildxb-my.sharepoint.com/:x:/g/personal/a_olivero_alumil_ae/EVlOY6zQ8SRJmM9696IevO8BpoiOXwkzFe88_yRNe2kC2A?e=tfIbS3";
  async function j(u){
  // If we're pointing at a SharePoint Excel link, emulate the old JSON API:
  if ((typeof BASE === "string") && BASE.includes("sharepoint.com")) {
    // Ensure loader + workbook
    if (typeof loadWorkbook !== "function") {
      throw new Error("XLSX loader not found. Ensure xlsx.full.min.js and js/sharepoint_loader.js are loaded.");
    }
    if (!window.__SP_WB_LOADED__) {
      await loadWorkbook(BASE);
      window.__SP_WB_LOADED__ = true;
    }
    // Extract sheet=Name from the URL and return rows from that sheet
    try {
      const qs = (u.split("?")[1] || "");
      const params = new URLSearchParams(qs);
      const sheet = params.get("sheet") || "Config";
      const rows = getSheetJSON(sheet);
      return rows || [];
    } catch (e) {
      console.error("SharePoint sheet load failed:", e);
      return [];
    }
  }

  // Fallback: original JSON fetch behavior
  const r = await fetch(u, {mode:'cors'});
  if(!r.ok) throw 0;
  return r.json();
}

); if(!r.ok) throw 0; return r.json(); }

  // 1) Local cache + version
  let local = {}, localVersion = null;
  try { local = JSON.parse(localStorage.getItem('excelCache') || '{}'); localVersion = local?.version || null; } catch { local = {}; }

  // 2) Remote config (version, sheet names)
  let cfg = { version: null, sheetProfiles: "Profile", sheetAccessories: "Accessories" };
  try {
    const rows = await j(BASE + (BASE.includes('?')?'&':'?') + 'sheet=Config');
    const map = Object.fromEntries((rows || []).filter(r => r && r.key).map(r => [r.key, r.value]));
    cfg = Object.assign(cfg, map);
  } catch (_){
    // no Config found -> force refresh
  }

  const remoteVersion = cfg.version || null;
  const hasData = (Array.isArray(local?.profiles) && local.profiles.length) || (Array.isArray(local?.accessories) && local.accessories.length);

  // 3) If same version and have data -> keep cache
  if (remoteVersion && localVersion && remoteVersion === localVersion && hasData) return;

  // 4) Fetch fresh data from configured sheets
  try {
    const urlP = BASE + (BASE.includes('?')?'&':'?') + 'sheet=' + encodeURIComponent(cfg.sheetProfiles || 'Profile');
    const urlA = BASE + (BASE.includes('?')?'&':'?') + 'sheet=' + encodeURIComponent(cfg.sheetAccessories || 'Accessories');
    const [p, a] = await Promise.all([ j(urlP), j(urlA) ]);
    const profiles = Array.isArray(p) ? p : (p?.data || []);
    const accessories = Array.isArray(a) ? a : (a?.data || []);

    localStorage.setItem('excelCache', JSON.stringify({
      profiles, accessories,
      version: remoteVersion,
      fileName: `SharePoint: ${cfg.sheetProfiles} + ${cfg.sheetAccessories}`,
      loadedAt: new Date().toISOString()
    }));
    console.log('[bootstrap] excelCache updated to version', remoteVersion);
  } catch (e) {
    console.warn('Versioned bootstrap failed:', e);
  }
});
</script>

  <script src="js/sharepoint_loader.js"></script>
</body>
</html>
