<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alumil • Sign In</title>

  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; font-src 'self' data:; connect-src 'self' https://*.supabase.co">

  <link rel="preload" as="image" href="/assets/images/bg-login.png" />
  
  <!-- Supabase Configuration -->
  <meta name="supabase-url" content="https://grsikgldzkqntlotawyi.supabase.co">
  <meta name="supabase-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyc2lrZ2xkemtxbnRsb3Rhd3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTQ0NTQsImV4cCI6MjA3NTE3MDQ1NH0.RtGvQ7vDNFNiabghTWVEzFroA4Z_fc8ZTr9p07fk_eQ">
  
  <!-- Supabase JS Library (loading before auth helper) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Auth Helper -->
  <script src="/js/auth-helper.js"></script>
  
  <!-- Session Checker - Validates auth state -->
  <script src="/js/session-checker.js"></script>
  <script src="/js/client-logging.js"></script>

  <style>
    :root{ --overlay-top: .35; --overlay-bottom: .45; --card-bg: rgb(255 255 255 / .08); --card-border: rgb(255 255 255 / .15); --text-dim: rgb(255 255 255 /.85); --accent: #ffc107; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: #f8f9fa; background:#111; overflow:hidden; }
  .bg { position:fixed; inset:0; background: linear-gradient(180deg, rgb(0 0 0 / var(--overlay-top)) 0%, rgb(0 0 0 / var(--overlay-bottom)) 100%), url("/assets/images/bg-login.png") center/cover no-repeat fixed, url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='16'%20height='9'%3E%3Crect%20width='100%25'%20height='100%25'%20fill='%23111111'/%3E%3C/svg%3E") center/cover no-repeat fixed; z-index:-1; }
    .bg::after{content:"";position:absolute;inset:0;pointer-events:none; background: radial-gradient(60% 60% at 70% 30%, rgb(255 255 255 / .06) 0%, transparent 60%), radial-gradient(50% 50% at 10% 90%, rgb(255 193 7 / .08) 0%, transparent 50%); mix-blend-mode:screen; }
    .wrap{ position:relative; height:100%; display:grid; place-items:center; padding:24px; }
    .card{ width:100%; max-width:480px; backdrop-filter: blur(8px); background: var(--card-bg); border:1px solid var(--card-border); border-radius:20px; padding:22px 22px 18px; box-shadow:0 10px 30px rgb(0 0 0 / .35); }
    .brand{ display:grid; place-items:center; gap:6px; margin-bottom:6px; text-align:center; }
    .brand img{ display:block; height:40px; width:auto; filter: drop-shadow(0 1px 1px rgba(0,0,0,.25)); }
    .tagline{ font-size:12px; color:var(--text-dim); letter-spacing:.2px; }

    /* Flags row — fixed with inline SVG, centered and evenly spaced */
    .flags{ display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:10px; margin: 10px 0 14px; }
    .flag{ width:32px; height:22px; border-radius:4px; overflow:hidden; border:1px solid rgb(255 255 255 / .35); box-shadow: inset 0 0 0 1px rgb(0 0 0 / .15); display:inline-block; }
    .flag svg{ display:block; width:100%; height:100%; }

    h1{ margin:8px 0 12px; font-size:24px; font-weight:800; letter-spacing:.2px; text-align:center; }
    p.sub{ margin:0 0 16px; font-size:14px; color:var(--text-dim); text-align:center; }

    label{ display:block; font-size:13px; opacity:.9; margin:12px 0 6px; }
    input{ width:100%; height:44px; border-radius:10px; border:1px solid rgb(255 255 255 / .25); background: rgb(255 255 255 / .1); color:#fff; padding:0 12px; outline:none; }
    input::placeholder{ color: rgb(255 255 255 / .7); }

    .btn{ position:relative; width:100%; height:46px; margin-top:16px; border:0; border-radius:12px; background: var(--accent); color:#222; font-weight:700; cursor:pointer; box-shadow: 0 6px 18px rgb(0 0 0 / .25); transition: transform .15s ease, box-shadow .2s ease, filter .2s ease; overflow:hidden; isolation:isolate; }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 22px rgb(0 0 0 / .30); filter: brightness(1.03); }
    .btn:active{ transform: translateY(0); box-shadow:0 6px 18px rgb(0 0 0 / .25); filter: brightness(.98); }
    .btn:disabled{ opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn::after{ content:""; position:absolute; top:-100%; left:-30%; width:60%; height:300%; transform: rotate(25deg); background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.4), rgba(255,255,255,0)); animation: sheen 2.4s infinite; opacity:.9; }
    @keyframes sheen{ 0%{transform:translateX(-140%) rotate(25deg);} 60%,100%{transform:translateX(240%) rotate(25deg);} }

    .or{ display:flex; align-items:center; gap:10px; margin:10px 0 6px; opacity:.9; font-size:12px; justify-content:center; }
    .or::before, .or::after{ content:""; height:1px; width:80px; background: rgb(255 255 255 / .35); }

    .aux{ display:flex; align-items:center; justify-content:space-between; margin-top:10px; font-size:13px; color:var(--text-dim); }
    .aux a{ color:#ffd54f; text-decoration:none; } .aux a:hover{ text-decoration:underline; }
    
    .error-message { background: rgba(255, 80, 80, .15); color: #ffd1d1; border: 1px solid rgba(255, 120, 120, .3); padding: 10px 12px; border-radius: 10px; font-size: 13px; margin-bottom: 14px; display: none; }
  </style>
</head>
<body>
  <div class="bg"></div>

  <div class="wrap">
    <div class="card">
      <div class="brand">
  <img src="/assets/images/alumil-logo.svg" alt="Alumil logo" />
        <div class="tagline">Building excellence every day</div>
      </div>

      <!-- Flags as inline SVG for perfect placement -->
      <div class="flags" aria-label="Languages">
        <!-- Greece -->
        <span class="flag" title="Greece">
          <svg viewBox="0 0 640 480" xmlns="http://www.w3.org/2000/svg">
            <rect width="640" height="480" fill="#0D5EAF"/>
            <g fill="#fff">
              <rect y="60" width="640" height="60"/>
              <rect y="180" width="640" height="60"/>
              <rect y="300" width="640" height="60"/>
              <rect y="420" width="640" height="60"/>
              <rect x="0" y="0" width="280" height="240" fill="#0D5EAF"/>
              <rect x="110" y="0" width="60" height="240"/>
              <rect x="0" y="90" width="280" height="60"/>
            </g>
          </svg>
        </span>
        <!-- Romania -->
        <span class="flag" title="Romania">
          <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
            <rect width="1" height="2" fill="#002B7F"/>
            <rect x="1" width="1" height="2" fill="#FCD116"/>
            <rect x="2" width="1" height="2" fill="#CE1126"/>
          </svg>
        </span>
        <!-- Italy -->
        <span class="flag" title="Italy">
          <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
            <rect width="1" height="2" fill="#009246"/>
            <rect x="1" width="1" height="2" fill="#F1F2F1"/>
            <rect x="2" width="1" height="2" fill="#CE2B37"/>
          </svg>
        </span>
        <!-- Bulgaria -->
        <span class="flag" title="Bulgaria">
          <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
            <rect width="3" height="2" fill="#FFFFFF"/>
            <rect y="0.666" width="3" height="0.667" fill="#00966E"/>
            <rect y="1.333" width="3" height="0.667" fill="#D62612"/>
          </svg>
        </span>
        <!-- Germany -->
        <span class="flag" title="Germany">
          <svg viewBox="0 0 5 3" xmlns="http://www.w3.org/2000/svg">
            <rect width="5" height="1" fill="#000000"/>
            <rect y="1" width="5" height="1" fill="#DD0000"/>
            <rect y="2" width="5" height="1" fill="#FFCE00"/>
          </svg>
        </span>
        <!-- United Arab Emirates -->
        <span class="flag" title="United Arab Emirates">
          <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
            <rect width="0.6" height="2" fill="#FF0000"/>
            <rect x="0.6" width="2.4" height="0.666" fill="#00732F"/>
            <rect x="0.6" y="0.666" width="2.4" height="0.667" fill="#FFFFFF"/>
            <rect x="0.6" y="1.333" width="2.4" height="0.667" fill="#000000"/>
          </svg>
        </span>
        <!-- Spain -->
        <span class="flag" title="Spain">
          <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
            <rect width="3" height="2" fill="#AA151B"/>
            <rect y="0.333" width="3" height="1.334" fill="#F1BF00"/>
          </svg>
        </span>
      </div>

      <h1>Sign In</h1>
      <p class="sub">Access your Inventory Management System</p>

      <div class="error-message" id="error-message"></div>

      <form id="login-form">
        <label for="email">Email Address</label>
        <input id="email" type="email" placeholder="you@example.com" required />

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="••••••••" required />

        <button class="btn" type="submit" id="login-btn">Sign In</button>
      </form>

  <p class="sub" style="margin-top:12px; font-size:12px; color:rgb(255 255 255 / .7);">If you just signed up, please verify your email first using the link sent to your inbox. Didn't receive it? Check your spam folder or try signing up again.</p>

      <div class="or"><span>OR</span></div>

      <div class="aux">
        <a href="./forgot-password.html">Forgot password?</a>
        <a href="./signup.html">Don't have an account? Request access</a>
      </div>
    </div>
  </div>


  <script>
    // Enhanced Singleton implementation for Supabase client
    window.getSupabaseClient = function() {
      if (window._sbClient) {
        return window._sbClient;
      }
      
      try {
        const supabaseUrl = document.querySelector('meta[name="supabase-url"]').content;
        const supabaseKey = document.querySelector('meta[name="supabase-key"]').content;
        
        window._sbClient = supabase.createClient(supabaseUrl, supabaseKey, {
          auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: true,
            storageKey: 'alumil_auth_token'
          }
        });
        
        return window._sbClient;
      } catch (e) {
        console.error('Failed to initialize Supabase client:', e);
        return null;
      }
    };
    
    // Initialize the client
    const directSupabase = getSupabaseClient();
    
    document.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('login-form');
      const loginBtn = document.getElementById('login-btn');
      const errorMessage = document.getElementById('error-message');
      
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
      }
      
      function hideError() {
        errorMessage.style.display = 'none';
      }
      
      function pulse(el) {
        el.animate(
          [{ transform: 'scale(1)' }, { transform: 'scale(0.98)' }, { transform: 'scale(1)' }],
          { duration: 180, easing: 'ease-out' }
        );
      }
      
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        
        if (!email || !password) {
          showError('Please enter both email and password');
          return;
        }
        
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(email)) {
          showError('Please enter a valid email address');
          return;
        }
        
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';
        pulse(loginBtn);
        
        try {
          if (window.authHelper) {
            const result = await window.authHelper.loginWithEmail(email, password);
            
            if (!result.success) {
              showError(result.error?.message || 'Login failed');
              return;
            }
            
            const isAdmin = await window.authHelper.checkIsAdmin();
            setTimeout(() => {
              window.location.replace(isAdmin ? 'admin.html' : 'home.html');
            }, 100);
            return;
          } else {
            const result = await directSupabase.auth.signInWithPassword({
              email,
              password,
            });
            
            if (result.error) {
              showError(result.error.message || 'Login failed');
              return;
            }
            
            const user = result.data.user;
            const { data: profile } = await directSupabase
              .from('profiles')
              .select('role, is_admin')
              .eq('id', user.id)
              .single();
            
            const isAdmin = (profile && (profile.role === 'admin' || profile.is_admin === true));
            
            setTimeout(() => {
              window.location.replace(isAdmin ? 'admin.html' : 'home.html');
            }, 100);
            return;
          }
        } catch (error) {
          if (error.message) {
            showError('Error: ' + error.message);
          } else {
            showError('An unexpected error occurred. Please try again.');
          }
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
        }
      });
      
      // Signup modal code removed: site uses separate signup.html page instead of modal.
      
      // Check if user is already logged in
      async function checkExistingSession() {
        try {
          const supabaseClient = window.getSupabaseClient();
          if (!supabaseClient) return;
          
          const { data, error } = await supabaseClient.auth.getSession();
          if (error) return;
          
          if (data?.session) {
            try {
              const { data: profile } = await supabaseClient
                .from('profiles')
                .select('is_admin,email')
                .eq('id', data.session.user.id)
                .single();
              
              if (profile?.is_admin) {
                location.href = 'admin.html';
              } else {
                location.href = 'home.html';
              }
            } catch (profileError) {
              location.href = 'home.html';
            }
          }
        } catch (e) {
          console.error("Session check failed:", e);
        }
      }
      
      checkExistingSession();
    });
  </script>

</body>
</html>